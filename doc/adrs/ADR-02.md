# ADR-02: Выбор aiogram в качестве фреймворка для Telegram-бота

**Статус:** Принято

**Дата:** 2025-10-10

**Контекст:** Разрабатываем LLM-ассистента в виде Telegram-бота для ведения диалога с пользователем в заданной роли

## Контекст и проблема

Для реализации Telegram-бота необходимо выбрать Python-фреймворк для работы с Telegram Bot API. Основные требования:
- Асинхронная архитектура для эффективной работы с LLM API
- Удобное управление состояниями диалога
- Простота интеграции с OpenAI API
- Гибкая система маршрутизации сообщений
- Хорошая документация и поддержка
- Современный и чистый код

## Рассмотренные варианты

1. **aiogram 3.x** - современный асинхронный фреймворк
2. **python-telegram-bot 20.x** - зрелый фреймворк с большим сообществом
3. **telebot (pyTelegramBotAPI)** - простой синхронный фреймворк
4. **pyrogram** - фреймворк на базе MTProto

## Решение

Выбран **aiogram 3.x** в качестве основного фреймворка для разработки Telegram-бота.

## Обоснование

### Преимущества aiogram

- **Нативная асинхронность**: Построен с нуля под asyncio, идеально сочетается с асинхронными вызовами OpenAI API
- **FSM (Finite State Machine)**: Встроенная система состояний для управления диалогами и ролями
- **Роутеры**: Модульная система маршрутизации для организации кода
- **Middleware**: Удобная система middleware для управления контекстом диалога
- **Dependency Injection**: Встроенная DI система упрощает тестирование и масштабирование
- **Магические фильтры**: Удобный синтаксис для фильтрации сообщений (F.text, F.photo и т.д.)
- **Производительность**: Высокая производительность при обработке множественных запросов
- **Документация на русском**: Качественная документация на русском языке
- **Современный код**: Чистый и понятный код, следует современным практикам Python

### Почему не python-telegram-bot

Хотя python-telegram-bot более зрелый и имеет большее сообщество:
- Более вербозный синтаксис
- Менее удобная система состояний (ConversationHandler)
- Переписан на async только в v20, меньше оптимизирован для asyncio
- Больше boilerplate кода

### Сравнение производительности

При работе с LLM API происходят задержки 1-5 секунд на запрос. Асинхронная архитектура aiogram позволит боту эффективно обрабатывать множество параллельных диалогов без блокировок.

## Последствия

### Положительные

- **Чистая архитектура**: Модульная структура с роутерами и middleware
- **Эффективность**: Отличная производительность при множественных пользователях
- **Удобство разработки**: Меньше boilerplate кода, быстрая разработка MVP
- **Управление состояниями**: FSM идеально подходит для ролевых диалогов
- **Масштабируемость**: Легко добавлять новые функции через роутеры
- **Интеграция с OpenAI**: Естественная интеграция с async OpenAI клиентом

### Отрицательные

- **Меньшее сообщество**: По сравнению с python-telegram-bot меньше примеров в Stack Overflow
- **Версия 3.x**: Относительно новая версия, breaking changes с 2.x
- **Обучение**: Требуется понимание asyncio и FSM концепций

### Риски и митигация

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Breaking changes в будущих версиях | Средняя | Фиксация версии, тесты |
| Недостаток примеров | Низкая | Хорошая официальная документация |
| Сложность для новичков | Низкая | Следование KISS, документирование кода |

## Технические детали

### Основные компоненты

- **Bot**: Основной объект для взаимодействия с Telegram API
- **Dispatcher**: Диспетчер для обработки обновлений
- **Router**: Модульная маршрутизация сообщений
- **FSM**: Управление состояниями диалога
- **Middleware**: Обработка запросов на уровне middleware
- **Filters**: Фильтрация входящих сообщений

### Структура проекта

```
src/
├── bot.py              # Точка входа
├── config.py           # Конфигурация
├── handlers/           # Обработчики команд и сообщений
│   ├── __init__.py
│   ├── start.py
│   └── dialog.py
├── middleware/         # Middleware для контекста
│   ├── __init__.py
│   └── context.py
├── states/             # FSM состояния
│   ├── __init__.py
│   └── dialog.py
├── services/           # Бизнес-логика
│   ├── __init__.py
│   ├── llm.py         # Интеграция с OpenAI
│   └── context.py     # Управление контекстом
└── models/             # Модели данных
    ├── __init__.py
    └── role.py
```

### Зависимости

```
aiogram==3.x
openai==1.x
python-dotenv==1.0.x
pydantic==2.x         # Для валидации конфигурации
```

### Пример интеграции с OpenAI

```python
from aiogram import Router, F
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from services.llm import get_llm_response

router = Router()

@router.message(F.text)
async def handle_message(message: Message, state: FSMContext):
    # Получаем контекст из FSM
    context = await state.get_data()
    
    # Вызываем LLM (асинхронно)
    response = await get_llm_response(
        message.text,
        context.get("messages", [])
    )
    
    # Отправляем ответ
    await message.answer(response)
    
    # Обновляем контекст
    await state.update_data(messages=context.get("messages", []) + [
        {"role": "user", "content": message.text},
        {"role": "assistant", "content": response}
    ])
```

## Альтернативный путь

Если в будущем aiogram не будет удовлетворять требованиям:
- Миграция на **python-telegram-bot** при необходимости более стабильного API
- Использование **pyrogram** для доступа к MTProto (расширенные возможности)

Архитектура должна изолировать Telegram-специфичную логику для упрощения миграции.

## Критерии пересмотра решения

Решение должно быть пересмотрено если:
- Обнаружатся критические баги в aiogram 3.x без быстрых исправлений
- Производительность не будет соответствовать требованиям (> 100 RPS)
- Потребуются функции, недоступные в aiogram
- Проект станет слишком сложным для команды без опыта asyncio

## Связанные решения

- ADR-01: Выбор OpenAI в качестве LLM-провайдера
- [Будущее] ADR-03: Стратегия хранения контекста диалогов
- [Будущее] ADR-04: Архитектура системы промптов

## Ссылки

- [aiogram Documentation](https://docs.aiogram.dev/)
- [aiogram GitHub](https://github.com/aiogram/aiogram)
- [Telegram Bot API](https://core.telegram.org/bots/api)
- [aiogram Examples](https://github.com/aiogram/aiogram/tree/dev-3.x/examples)

